<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>LITM: project/includes/switch.h File Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>project/includes/switch.h File Reference</h1><hr><a name="_details"></a><h2>Detailed Description</h2>
<dl class="date" compact><dt><b>Date:</b></dt><dd>2009-04-25 </dd></dl>
<dl class="author" compact><dt><b>Author:</b></dt><dd>Jean-Lou Dupont </dd></dl>

<p>Definition in file <a class="el" href="switch_8h-source.html">switch.h</a>.</p>

<p>
<code>#include &lt;pthread.h&gt;</code><br>

<p>
<div class="dynheader">
Include dependency graph for switch.h:</div>
<div class="dynsection">
<p><center><img src="switch_8h__incl.png" border="0" usemap="#project/includes/switch.h_map" alt=""></center>
</div>

<p>
<div class="dynheader">
This graph shows which files directly or indirectly include this file:</div>
<div class="dynsection">
<p><center><img src="switch_8h__dep__incl.png" border="0" usemap="#project/includes/switch.hdep_map" alt=""></center>
<map name="project/includes/switch.hdep_map">
<area shape="rect" href="switch_8c.html" title="project/src/switch.c" alt="" coords="20,80,153,107"></map>
</div>

<p>
<a href="switch_8h-source.html">Go to the source code of this file.</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="switch_8h.html#cf83bfcffad6990c781b1a668ec8209e">switch_init</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="switch_8h.html#e3d353fd292b45761954aa21d793017d">switch_thread_function</a> (void *params)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="litm_8h.html#a1c70492a41df506aa1156ea7d36c4de">litm_code</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="switch_8h.html#c5408c5b37244e5d0fe17f55f1c3f89e">switch_add_subscriber</a> (<a class="el" href="struct__litm__connection.html">litm_connection</a> *conn, <a class="el" href="litm_8h.html#e7fcc1b5cd037f318d4fe40a2f9d30d3">litm_bus</a> bus_id)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="litm_8h.html#a1c70492a41df506aa1156ea7d36c4de">litm_code</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="switch_8h.html#a12d12ec55e370e7b2d960a67ab19078">switch_remove_subscriber</a> (<a class="el" href="struct__litm__connection.html">litm_connection</a> *conn, <a class="el" href="litm_8h.html#e7fcc1b5cd037f318d4fe40a2f9d30d3">litm_bus</a> bus_id)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="litm_8h.html#a1c70492a41df506aa1156ea7d36c4de">litm_code</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="switch_8h.html#7ff2d602f713f81e854c172e842afcad">switch_send</a> (<a class="el" href="struct__litm__connection.html">litm_connection</a> *conn, <a class="el" href="litm_8h.html#e7fcc1b5cd037f318d4fe40a2f9d30d3">litm_bus</a> bus_id, void *msg, void(*cleaner)(void *msg))</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="litm_8h.html#a1c70492a41df506aa1156ea7d36c4de">litm_code</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="switch_8h.html#2bab91639e612d51d0d7d8a3a64d0ace">switch_release</a> (<a class="el" href="struct__litm__connection.html">litm_connection</a> *conn, <a class="el" href="struct__litm__envelope.html">litm_envelope</a> *envlp)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="c5408c5b37244e5d0fe17f55f1c3f89e"></a><!-- doxytag: member="switch.h::switch_add_subscriber" ref="c5408c5b37244e5d0fe17f55f1c3f89e" args="(litm_connection *conn, litm_bus bus_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="litm_8h.html#a1c70492a41df506aa1156ea7d36c4de">litm_code</a> switch_add_subscriber           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="struct__litm__connection.html">litm_connection</a> *&nbsp;</td>
          <td class="paramname"> <em>conn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="litm_8h.html#e7fcc1b5cd037f318d4fe40a2f9d30d3">litm_bus</a>&nbsp;</td>
          <td class="paramname"> <em>bus_id</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="switch_8c-source.html#l00264">264</a> of file <a class="el" href="switch_8c-source.html">switch.c</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00264"></a>00264                                                               {
<a name="l00265"></a>00265 
<a name="l00266"></a>00266         <span class="keywordflow">if</span> (NULL==conn) {
<a name="l00267"></a>00267                 <span class="keywordflow">return</span> <a class="code" href="litm_8h.html#9b8b4b198f82bf2ad2eea38062d62293030ffb6b9de7d729330056b0c40eeaa4">LITM_CODE_ERROR_BAD_CONNECTION</a>;
<a name="l00268"></a>00268         }
<a name="l00269"></a>00269 
<a name="l00270"></a>00270         <span class="keywordflow">if</span> (( <a class="code" href="litm_8h.html#fbd708ff493c92eb23ebf90685253660">LITM_BUSSES_MAX</a> &lt; bus_id ) || (0&gt;=bus_id)) {
<a name="l00271"></a>00271                 <span class="keywordflow">return</span> <a class="code" href="litm_8h.html#9b8b4b198f82bf2ad2eea38062d622933f8543ac2f3b59248fb667f2adfa2263">LITM_CODE_ERROR_INVALID_BUS</a>;
<a name="l00272"></a>00272         }
<a name="l00273"></a>00273 
<a name="l00274"></a>00274         <span class="keywordtype">int</span> code = pthread_mutex_trylock( &amp;<a class="code" href="switch_8c.html#66b222465cf692f5b9da017fa259dda1">_subscribers_mutex</a> );
<a name="l00275"></a>00275         <span class="keywordflow">if</span> (EBUSY==code)
<a name="l00276"></a>00276                 <span class="keywordflow">return</span> <a class="code" href="litm_8h.html#9b8b4b198f82bf2ad2eea38062d622939fd144765aaaf968cb7a7b7fa847a278">LITM_CODE_BUSY</a>;
<a name="l00277"></a>00277 
<a name="l00278"></a>00278         <span class="keywordtype">int</span> result=<a class="code" href="litm_8h.html#9b8b4b198f82bf2ad2eea38062d622933f8543ac2f3b59248fb667f2adfa2263">LITM_CODE_ERROR_INVALID_BUS</a>;
<a name="l00279"></a>00279         <span class="keywordtype">int</span> index;
<a name="l00280"></a>00280         <span class="keywordflow">for</span> (index=1; index&lt;<a class="code" href="litm_8h.html#1b077a43eb60b36c3a0d6d4d71cf1fac">LITM_CONNECTION_MAX</a>; index++) {
<a name="l00281"></a>00281                 <span class="keywordflow">if</span> (NULL==<a class="code" href="switch_8c.html#1945b3d804ccad8849548539b52a86bd">_subscribers</a>[bus_id][index]) {
<a name="l00282"></a>00282                         <a class="code" href="switch_8c.html#1945b3d804ccad8849548539b52a86bd">_subscribers</a>[bus_id][index] = conn;
<a name="l00283"></a>00283                         result = <a class="code" href="litm_8h.html#9b8b4b198f82bf2ad2eea38062d622930b651a4f84388b526d32980e3b43c4a2">LITM_CODE_OK</a>;
<a name="l00284"></a>00284                         <span class="keywordflow">break</span>;
<a name="l00285"></a>00285                 }
<a name="l00286"></a>00286         }
<a name="l00287"></a>00287 
<a name="l00288"></a>00288         pthread_mutex_unlock( &amp;<a class="code" href="switch_8c.html#66b222465cf692f5b9da017fa259dda1">_subscribers_mutex</a> );
<a name="l00289"></a>00289 
<a name="l00290"></a>00290         <span class="keywordflow">return</span> result;
<a name="l00291"></a>00291 }<span class="comment">//</span>
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
<p><center><img src="switch_8h_c5408c5b37244e5d0fe17f55f1c3f89e_icgraph.png" border="0" usemap="#switch_8h_c5408c5b37244e5d0fe17f55f1c3f89e_icgraph_map" alt=""></center>
<map name="switch_8h_c5408c5b37244e5d0fe17f55f1c3f89e_icgraph_map">
<area shape="rect" href="litm_8h.html#1c8191e4aca778b346954933c7bdf3ff" title="litm_subscribe" alt="" coords="209,5,313,32"></map>
</div>

</div>
</div><p>
<a class="anchor" name="cf83bfcffad6990c781b1a668ec8209e"></a><!-- doxytag: member="switch.h::switch_init" ref="cf83bfcffad6990c781b1a668ec8209e" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int switch_init           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="switch_8c-source.html#l00051">51</a> of file <a class="el" href="switch_8c-source.html">switch.c</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00051"></a>00051                   {
<a name="l00052"></a>00052 
<a name="l00053"></a>00053         <span class="keywordflow">if</span> (0== <a class="code" href="switch_8c.html#4d96ee71c32e710320da8ab5b7da249a">_switchThread_id</a>) {
<a name="l00054"></a>00054                 <a class="code" href="logger_8h.html#21a2c7330a04ac78200a986f66609369">DEBUG_LOG</a>(LOG_INFO, <span class="stringliteral">"switch_init: creating switch thread &amp; queue"</span>);
<a name="l00055"></a>00055                 <a class="code" href="switch_8c.html#45d2c8f54ca279893a75408e9164be6a">_switch_queue</a> = <a class="code" href="queue_8c.html#404f283e7764be86026fda0714b6b7b6">queue_create</a>();
<a name="l00056"></a>00056                 <a class="code" href="switch_8c.html#4d96ee71c32e710320da8ab5b7da249a">_switchThread_id</a> = pthread_create(&amp;<a class="code" href="switch_8c.html#cb3ec39b5454e93fd98267ce8a0d7bab">_switchThread</a>, NULL, &amp;<a class="code" href="switch_8c.html#99ec0a50e5e594cb656f9ea1f7d39554">__switch_thread_function</a>, NULL);
<a name="l00057"></a>00057         }
<a name="l00058"></a>00058 }<span class="comment">//</span>
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<p><center><img src="switch_8h_cf83bfcffad6990c781b1a668ec8209e_cgraph.png" border="0" usemap="#switch_8h_cf83bfcffad6990c781b1a668ec8209e_cgraph_map" alt=""></center>
<map name="switch_8h_cf83bfcffad6990c781b1a668ec8209e_cgraph_map">
<area shape="rect" href="switch_8c.html#99ec0a50e5e594cb656f9ea1f7d39554" title="__switch_thread_function" alt="" coords="136,182,304,209"><area shape="rect" href="queue_8c.html#404f283e7764be86026fda0714b6b7b6" title="queue_create" alt="" coords="171,233,269,260"><area shape="rect" href="switch_8c.html#149e07f06e61c0daee8f4cf38200dff2" title="__switch_finalize" alt="" coords="401,56,521,82"><area shape="rect" href="switch_8c.html#428d719295458c6a33de960ab47a3594" title="__switch_get_next_subscriber" alt="" coords="364,157,559,184"><area shape="rect" href="switch_8c.html#a915fa62ee3a445f9acac19e744005e3" title="__switch_try_sending_or_requeue" alt="" coords="353,233,569,260"><area shape="rect" href="queue_8c.html#819eed56d043a96499116f087d928057" title="queue_get_nb" alt="" coords="411,284,512,310"><area shape="rect" href="pool_8c.html#1266647a6ed7c20e9c5d08f4bef09dd3" title="__litm_pool_recycle" alt="" coords="661,5,797,32"><area shape="rect" href="pool_8c.html#2f844d6f6d2a471a5a93c3c49c28eef2" title="__litm_pool_destroy" alt="" coords="889,5,1025,32"><area shape="rect" href="switch_8c.html#a94aad98c23f36ddee68fa7c14b4dfba" title="__switch_find_match" alt="" coords="657,56,801,82"><area shape="rect" href="switch_8c.html#6ff5c1db987d3bf46b124d28967954a4" title="__switch_find_next_non_match" alt="" coords="628,106,831,133"><area shape="rect" href="connection_8c.html#9e582b29253857b58f87ba89f8a6526f" title="_litm_connections_lock" alt="" coords="651,157,808,184"><area shape="rect" href="connection_8c.html#c75b4b0413d3523574bda13549715447" title="_litm_connections_unlock" alt="" coords="644,208,815,234"><area shape="rect" href="switch_8c.html#1025953257d7d23c8473d945dbf0c9db" title="__switch_try_sending_to_recipient" alt="" coords="620,258,839,285"><area shape="rect" href="queue_8c.html#3d346fcf3a730d9e52e0b27359de6256" title="queue_put" alt="" coords="689,309,769,336"><area shape="rect" href="queue_8c.html#8cd65d2ab7ec27b19a655e9835de832c" title="queue_put_nb" alt="" coords="907,258,1008,285"></map>
</div>

<p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
<p><center><img src="switch_8h_cf83bfcffad6990c781b1a668ec8209e_icgraph.png" border="0" usemap="#switch_8h_cf83bfcffad6990c781b1a668ec8209e_icgraph_map" alt=""></center>
<map name="switch_8h_cf83bfcffad6990c781b1a668ec8209e_icgraph_map">
<area shape="rect" href="litm_8h.html#bc852d2eb14353e36adf21c33eab03a3" title="litm_connect" alt="" coords="136,5,232,32"></map>
</div>

</div>
</div><p>
<a class="anchor" name="2bab91639e612d51d0d7d8a3a64d0ace"></a><!-- doxytag: member="switch.h::switch_release" ref="2bab91639e612d51d0d7d8a3a64d0ace" args="(litm_connection *conn, litm_envelope *envlp)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="litm_8h.html#a1c70492a41df506aa1156ea7d36c4de">litm_code</a> switch_release           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="struct__litm__connection.html">litm_connection</a> *&nbsp;</td>
          <td class="paramname"> <em>conn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="struct__litm__envelope.html">litm_envelope</a> *&nbsp;</td>
          <td class="paramname"> <em>envlp</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
A client has finished processing a message: send it through through the ``input_queue`` and if all intended recipients have processed it already, it will be finalized. 
<p>Definition at line <a class="el" href="switch_8c-source.html#l00200">200</a> of file <a class="el" href="switch_8c-source.html">switch.c</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00200"></a>00200                                                             {
<a name="l00201"></a>00201 
<a name="l00202"></a>00202         <span class="keywordflow">if</span> (NULL==conn) {
<a name="l00203"></a>00203                 <span class="keywordflow">return</span> <a class="code" href="litm_8h.html#9b8b4b198f82bf2ad2eea38062d62293030ffb6b9de7d729330056b0c40eeaa4">LITM_CODE_ERROR_BAD_CONNECTION</a>;
<a name="l00204"></a>00204         }
<a name="l00205"></a>00205         <span class="keywordflow">if</span> (NULL==envlp) {
<a name="l00206"></a>00206                 <span class="keywordflow">return</span> <a class="code" href="litm_8h.html#9b8b4b198f82bf2ad2eea38062d622930aea3671c60548df5c630dfb89adf3bb">LITM_CODE_ERROR_INVALID_ENVELOPE</a>;
<a name="l00207"></a>00207         }
<a name="l00208"></a>00208 
<a name="l00209"></a>00209         <span class="comment">// if a message comes this way, it means a client</span>
<a name="l00210"></a>00210         <span class="comment">// has finished processing it... get rid of the</span>
<a name="l00211"></a>00211         <span class="comment">// "pending" state if at all present.</span>
<a name="l00212"></a>00212         envlp-&gt;<a class="code" href="struct__litm__envelope.html#7c7a351b72e9b4d084e526a00787a44f">routes</a>.<a class="code" href="struct____litm__routing.html#078e15223c87cc831becc4169d2f7a2f">pending</a> = 0;
<a name="l00213"></a>00213 
<a name="l00214"></a>00214         <span class="keywordtype">int</span> result = <a class="code" href="queue_8c.html#3d346fcf3a730d9e52e0b27359de6256">queue_put</a>(<a class="code" href="switch_8c.html#45d2c8f54ca279893a75408e9164be6a">_switch_queue</a>, (<span class="keywordtype">void</span> *) envlp);
<a name="l00215"></a>00215         <span class="keywordflow">if</span> (1 != result) {
<a name="l00216"></a>00216                 <a class="code" href="switch_8c.html#149e07f06e61c0daee8f4cf38200dff2">__switch_finalize</a>( envlp );
<a name="l00217"></a>00217                 <span class="keywordflow">return</span> <a class="code" href="litm_8h.html#9b8b4b198f82bf2ad2eea38062d6229369f5e764faddb58449c77b25df30dfc6">LITM_CODE_ERROR_MALLOC</a>;
<a name="l00218"></a>00218         }
<a name="l00219"></a>00219 
<a name="l00220"></a>00220         <span class="keywordflow">return</span> <a class="code" href="litm_8h.html#9b8b4b198f82bf2ad2eea38062d622930b651a4f84388b526d32980e3b43c4a2">LITM_CODE_OK</a>;
<a name="l00221"></a>00221 }<span class="comment">//</span>
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<p><center><img src="switch_8h_2bab91639e612d51d0d7d8a3a64d0ace_cgraph.png" border="0" usemap="#switch_8h_2bab91639e612d51d0d7d8a3a64d0ace_cgraph_map" alt=""></center>
<map name="switch_8h_2bab91639e612d51d0d7d8a3a64d0ace_cgraph_map">
<area shape="rect" href="switch_8c.html#149e07f06e61c0daee8f4cf38200dff2" title="__switch_finalize" alt="" coords="163,5,283,32"><area shape="rect" href="queue_8c.html#3d346fcf3a730d9e52e0b27359de6256" title="queue_put" alt="" coords="183,56,263,83"><area shape="rect" href="pool_8c.html#1266647a6ed7c20e9c5d08f4bef09dd3" title="__litm_pool_recycle" alt="" coords="331,5,467,32"><area shape="rect" href="pool_8c.html#2f844d6f6d2a471a5a93c3c49c28eef2" title="__litm_pool_destroy" alt="" coords="516,5,652,32"></map>
</div>

<p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
<p><center><img src="switch_8h_2bab91639e612d51d0d7d8a3a64d0ace_icgraph.png" border="0" usemap="#switch_8h_2bab91639e612d51d0d7d8a3a64d0ace_icgraph_map" alt=""></center>
<map name="switch_8h_2bab91639e612d51d0d7d8a3a64d0ace_icgraph_map">
<area shape="rect" href="litm_8h.html#21def412c9b064fc929e0822f28d2a2a" title="litm_release" alt="" coords="164,5,255,32"></map>
</div>

</div>
</div><p>
<a class="anchor" name="a12d12ec55e370e7b2d960a67ab19078"></a><!-- doxytag: member="switch.h::switch_remove_subscriber" ref="a12d12ec55e370e7b2d960a67ab19078" args="(litm_connection *conn, litm_bus bus_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="litm_8h.html#a1c70492a41df506aa1156ea7d36c4de">litm_code</a> switch_remove_subscriber           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="struct__litm__connection.html">litm_connection</a> *&nbsp;</td>
          <td class="paramname"> <em>conn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="litm_8h.html#e7fcc1b5cd037f318d4fe40a2f9d30d3">litm_bus</a>&nbsp;</td>
          <td class="paramname"> <em>bus_id</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="switch_8c-source.html#l00294">294</a> of file <a class="el" href="switch_8c-source.html">switch.c</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00294"></a>00294                                                                  {
<a name="l00295"></a>00295 
<a name="l00296"></a>00296         <span class="keywordflow">if</span> (NULL==conn) {
<a name="l00297"></a>00297                 <span class="keywordflow">return</span> <a class="code" href="litm_8h.html#9b8b4b198f82bf2ad2eea38062d62293030ffb6b9de7d729330056b0c40eeaa4">LITM_CODE_ERROR_BAD_CONNECTION</a>;
<a name="l00298"></a>00298         }
<a name="l00299"></a>00299 
<a name="l00300"></a>00300         <span class="keywordflow">if</span> (( <a class="code" href="litm_8h.html#fbd708ff493c92eb23ebf90685253660">LITM_BUSSES_MAX</a> &lt; bus_id ) || (0&gt;=bus_id)) {
<a name="l00301"></a>00301                 <span class="keywordflow">return</span> <a class="code" href="litm_8h.html#9b8b4b198f82bf2ad2eea38062d622933f8543ac2f3b59248fb667f2adfa2263">LITM_CODE_ERROR_INVALID_BUS</a>;
<a name="l00302"></a>00302         }
<a name="l00303"></a>00303 
<a name="l00304"></a>00304         <span class="keywordtype">int</span> code = pthread_mutex_trylock( &amp;<a class="code" href="switch_8c.html#66b222465cf692f5b9da017fa259dda1">_subscribers_mutex</a> );
<a name="l00305"></a>00305         <span class="keywordflow">if</span> (EBUSY==code)
<a name="l00306"></a>00306                 <span class="keywordflow">return</span> <a class="code" href="litm_8h.html#9b8b4b198f82bf2ad2eea38062d622939fd144765aaaf968cb7a7b7fa847a278">LITM_CODE_BUSY</a>;
<a name="l00307"></a>00307 
<a name="l00308"></a>00308         <span class="keywordtype">int</span> result=<a class="code" href="litm_8h.html#9b8b4b198f82bf2ad2eea38062d622933f8543ac2f3b59248fb667f2adfa2263">LITM_CODE_ERROR_INVALID_BUS</a>;
<a name="l00309"></a>00309         <span class="keywordtype">int</span> index;
<a name="l00310"></a>00310         <span class="keywordflow">for</span> (index=1; index&lt;<a class="code" href="litm_8h.html#1b077a43eb60b36c3a0d6d4d71cf1fac">LITM_CONNECTION_MAX</a>; index++) {
<a name="l00311"></a>00311                 <span class="keywordflow">if</span> (conn==<a class="code" href="switch_8c.html#1945b3d804ccad8849548539b52a86bd">_subscribers</a>[bus_id][index]) {
<a name="l00312"></a>00312                         <a class="code" href="switch_8c.html#1945b3d804ccad8849548539b52a86bd">_subscribers</a>[bus_id][index] = NULL;
<a name="l00313"></a>00313                         result = <a class="code" href="litm_8h.html#9b8b4b198f82bf2ad2eea38062d622930b651a4f84388b526d32980e3b43c4a2">LITM_CODE_OK</a>;
<a name="l00314"></a>00314                         <span class="keywordflow">break</span>;
<a name="l00315"></a>00315                 }
<a name="l00316"></a>00316         }
<a name="l00317"></a>00317 
<a name="l00318"></a>00318         pthread_mutex_unlock( &amp;<a class="code" href="switch_8c.html#66b222465cf692f5b9da017fa259dda1">_subscribers_mutex</a> );
<a name="l00319"></a>00319 
<a name="l00320"></a>00320         <span class="keywordflow">return</span> result;
<a name="l00321"></a>00321 }<span class="comment">//</span>
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
<p><center><img src="switch_8h_a12d12ec55e370e7b2d960a67ab19078_icgraph.png" border="0" usemap="#switch_8h_a12d12ec55e370e7b2d960a67ab19078_icgraph_map" alt=""></center>
<map name="switch_8h_a12d12ec55e370e7b2d960a67ab19078_icgraph_map">
<area shape="rect" href="litm_8h.html#50225024a2292b63a5eb95cca00f2545" title="litm_unsubscribe" alt="" coords="229,5,349,32"></map>
</div>

</div>
</div><p>
<a class="anchor" name="7ff2d602f713f81e854c172e842afcad"></a><!-- doxytag: member="switch.h::switch_send" ref="7ff2d602f713f81e854c172e842afcad" args="(litm_connection *conn, litm_bus bus_id, void *msg, void(*cleaner)(void *msg))" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="litm_8h.html#a1c70492a41df506aa1156ea7d36c4de">litm_code</a> switch_send           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="struct__litm__connection.html">litm_connection</a> *&nbsp;</td>
          <td class="paramname"> <em>conn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="litm_8h.html#e7fcc1b5cd037f318d4fe40a2f9d30d3">litm_bus</a>&nbsp;</td>
          <td class="paramname"> <em>bus_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>msg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void(*)(void *msg)&nbsp;</td>
          <td class="paramname"> <em>cleaner</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This function just queues up the message in the switch's input_queue without actually sending it to recipients.<p>
This function blocks whilst accessing the switch's ``input_queue`` but no deadlock scenario is possible since the switch's thread does not block whilst dequeuing. 
<p>Definition at line <a class="el" href="switch_8c-source.html#l00334">334</a> of file <a class="el" href="switch_8c-source.html">switch.c</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00335"></a>00335                                                     {
<a name="l00336"></a>00336 
<a name="l00337"></a>00337         <span class="keywordflow">if</span> (NULL==conn) {
<a name="l00338"></a>00338                 <span class="keywordflow">return</span> <a class="code" href="litm_8h.html#9b8b4b198f82bf2ad2eea38062d62293030ffb6b9de7d729330056b0c40eeaa4">LITM_CODE_ERROR_BAD_CONNECTION</a>;
<a name="l00339"></a>00339         }
<a name="l00340"></a>00340 
<a name="l00341"></a>00341         <span class="keywordflow">if</span> (( <a class="code" href="litm_8h.html#fbd708ff493c92eb23ebf90685253660">LITM_BUSSES_MAX</a> &lt; bus_id ) || (0&gt;=bus_id)) {
<a name="l00342"></a>00342                 <span class="keywordflow">return</span> <a class="code" href="litm_8h.html#9b8b4b198f82bf2ad2eea38062d622933f8543ac2f3b59248fb667f2adfa2263">LITM_CODE_ERROR_INVALID_BUS</a>;
<a name="l00343"></a>00343         }
<a name="l00344"></a>00344 
<a name="l00345"></a>00345         <span class="comment">// Grab an envelope &amp; init</span>
<a name="l00346"></a>00346         <a class="code" href="struct__litm__envelope.html">litm_envelope</a> *e=<a class="code" href="pool_8c.html#5a3eeccda0cfcf633af7177fad20c783">__litm_pool_get</a>();
<a name="l00347"></a>00347         e-&gt;<a class="code" href="struct__litm__envelope.html#9e1e2e92283fc88e458ab22c80ed5a10">cleaner</a> = cleaner;
<a name="l00348"></a>00348         e-&gt;<a class="code" href="struct__litm__envelope.html#7c7a351b72e9b4d084e526a00787a44f">routes</a>.<a class="code" href="struct____litm__routing.html#078e15223c87cc831becc4169d2f7a2f">pending</a> = 0; <span class="comment">//FALSE</span>
<a name="l00349"></a>00349         e-&gt;<a class="code" href="struct__litm__envelope.html#7c7a351b72e9b4d084e526a00787a44f">routes</a>.<a class="code" href="struct____litm__routing.html#1f7b0cd5a23c153bf0a244fd7cba6689">bus_id</a> = bus_id;
<a name="l00350"></a>00350         e-&gt;<a class="code" href="struct__litm__envelope.html#7c7a351b72e9b4d084e526a00787a44f">routes</a>.<a class="code" href="struct____litm__routing.html#855edf29452572a9d83b7d551c2b3a3b">sender</a> = conn;
<a name="l00351"></a>00351         e-&gt;<a class="code" href="struct__litm__envelope.html#7c7a351b72e9b4d084e526a00787a44f">routes</a>.<a class="code" href="struct____litm__routing.html#30882ea416f664293fb2f0468cb09e8b">current</a> = NULL;  <span class="comment">// First time sent</span>
<a name="l00352"></a>00352         e-&gt;<a class="code" href="struct__litm__envelope.html#5ed18526b98cb26460fdb273ea2178ac">msg</a> = msg;
<a name="l00353"></a>00353 
<a name="l00354"></a>00354         <span class="comment">/*</span>
<a name="l00355"></a>00355 <span class="comment">         *  Initial message submission: if something goes</span>
<a name="l00356"></a>00356 <span class="comment">         *  wrong, we need to get rid of envelope.</span>
<a name="l00357"></a>00357 <span class="comment">         */</span>
<a name="l00358"></a>00358         <span class="keywordtype">int</span> result = <a class="code" href="queue_8c.html#3d346fcf3a730d9e52e0b27359de6256">queue_put</a>(<a class="code" href="switch_8c.html#45d2c8f54ca279893a75408e9164be6a">_switch_queue</a>, (<span class="keywordtype">void</span> *) e);
<a name="l00359"></a>00359         <span class="keywordflow">if</span> (1 != result) {
<a name="l00360"></a>00360                 <a class="code" href="pool_8c.html#1266647a6ed7c20e9c5d08f4bef09dd3">__litm_pool_recycle</a>( e );
<a name="l00361"></a>00361                 <span class="keywordflow">return</span> <a class="code" href="litm_8h.html#9b8b4b198f82bf2ad2eea38062d6229369f5e764faddb58449c77b25df30dfc6">LITM_CODE_ERROR_MALLOC</a>;
<a name="l00362"></a>00362         }
<a name="l00363"></a>00363 
<a name="l00364"></a>00364         <span class="keywordflow">return</span> <a class="code" href="litm_8h.html#9b8b4b198f82bf2ad2eea38062d622930b651a4f84388b526d32980e3b43c4a2">LITM_CODE_OK</a>;
<a name="l00365"></a>00365 }<span class="comment">//</span>
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<p><center><img src="switch_8h_7ff2d602f713f81e854c172e842afcad_cgraph.png" border="0" usemap="#switch_8h_7ff2d602f713f81e854c172e842afcad_cgraph_map" alt=""></center>
<map name="switch_8h_7ff2d602f713f81e854c172e842afcad_cgraph_map">
<area shape="rect" href="pool_8c.html#5a3eeccda0cfcf633af7177fad20c783" title="__litm_pool_get" alt="" coords="159,6,271,32"><area shape="rect" href="pool_8c.html#1266647a6ed7c20e9c5d08f4bef09dd3" title="__litm_pool_recycle" alt="" coords="147,56,283,83"><area shape="rect" href="queue_8c.html#3d346fcf3a730d9e52e0b27359de6256" title="queue_put" alt="" coords="175,107,255,134"><area shape="rect" href="pool_8c.html#ad0b7166470e29cb5024efeca7d035af" title="__litm_pool_clean" alt="" coords="337,6,463,32"><area shape="rect" href="pool_8c.html#2f844d6f6d2a471a5a93c3c49c28eef2" title="__litm_pool_destroy" alt="" coords="332,56,468,83"></map>
</div>

<p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
<p><center><img src="switch_8h_7ff2d602f713f81e854c172e842afcad_icgraph.png" border="0" usemap="#switch_8h_7ff2d602f713f81e854c172e842afcad_icgraph_map" alt=""></center>
<map name="switch_8h_7ff2d602f713f81e854c172e842afcad_icgraph_map">
<area shape="rect" href="litm_8h.html#bed13398c1bc31a6c81c3e50997e2f2c" title="litm_send" alt="" coords="147,5,224,32"></map>
</div>

</div>
</div><p>
<a class="anchor" name="e3d353fd292b45761954aa21d793017d"></a><!-- doxytag: member="switch.h::switch_thread_function" ref="e3d353fd292b45761954aa21d793017d" args="(void *params)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void* switch_thread_function           </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>params</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
</div>
<hr size="1"><address style="text-align: right;"><small>Generated on Tue Apr 28 10:16:04 2009 for LITM by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.6 </small></address>
</body>
</html>
